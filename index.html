<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>患者資料管理 PWA</title>

<!-- 字型與樣式 -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
<style>
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        background: #f8f9fb;
        color: #333;
    }
    header {
        background: #dfe6ec;
        padding: 16px;
        text-align: center;
        font-size: 20px;
        font-weight: 500;
        color: #2d3e50;
    }
    .container {
        padding: 20px;
        max-width: 700px;
        margin: auto;
    }
    label { display: block; margin-top: 10px; font-weight: 500; }
    input, textarea, button {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #bbc7d4;
        font-size: 16px;
        box-sizing: border-box;
    }
    button {
        background-color: #4a76b6;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-top: 15px;
    }
    button:hover { background-color: #3d64a1; }

    /* 顯示區 */
    .result-card {
        background: #ffffff;
        padding: 15px;
        margin-top: 15px;
        border-radius: 10px;
        border: 1px solid #d5dce3;
    }
    .actions button {
        width: 48%;
        margin-top: 10px;
        background: #5aa469;
    }
    .actions button.delete { background: #c75c5c; }

    /* 手機優化 */
    @media (max-width: 480px) {
        header { font-size: 18px; }
    }
</style>
</head>
<body>

<header>患者資料管理</header>

<div class="container">

    <!-- 搜尋 -->
    <label>姓名或病歷號搜尋</label>
    <input type="text" id="searchInput" placeholder="輸入姓名或病歷號">
    <button onclick="searchRecord()">搜尋</button>

    <!-- 結果顯示 -->
    <div id="searchResult"></div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccd6e0;">

    <!-- 新增、編輯資料 -->
    <h3 id="formTitle">新增患者資料</h3>
    <label>姓名</label>
    <input type="text" id="name">

    <label>病歷號碼</label>
    <input type="text" id="record">

    <label>注意事項</label>
    <textarea id="note"></textarea>

    <button onclick="saveRecord()" id="saveBtn">儲存</button>

</div>

<script>
const api = "https://script.google.com/macros/s/AKfycbxa4GFiDtkde9gm-S1UddDhN6i8LoNP-EFpSPrkyFs5ikjVVKMDqWSkCkZHKVsqiawgZA/exec";
let editingId = null;

/* 儲存資料 */
function saveRecord() {
    const name = document.getElementById("name").value.trim();
    const record = document.getElementById("record").value.trim();
    const note = document.getElementById("note").value.trim();

    if (!name || !record) {
        alert("姓名及病歷號碼為必填");
        return;
    }

    fetch(api, {
        method: "POST",
        body: new URLSearchParams({
            action: editingId ? "edit" : "add",
            id: editingId || "",
            name,
            record,
            note
        })
    }).then(r => r.text()).then(data => {
        alert(data);
        location.reload();
    });
}

/* 搜尋 */
function searchRecord() {
    let keyword = document.getElementById("searchInput").value.trim();
    if (!keyword) {
        alert("請輸入關鍵字");
        return;
    }
    fetch(api + "?action=search&keyword=" + keyword)
        .then(res => res.json())
        .then(data => showResult(data));
}

/* 顯示結果 */
function showResult(data) {
    const div = document.getElementById("searchResult");
    div.innerHTML = "";
    if (!data || data.length === 0) {
        div.innerHTML = "<p>查無資料</p>";
        return;
    }
    data.forEach(item => {
        div.innerHTML += `
        <div class="result-card">
            <b>姓名：</b>${item.name}<br>
            <b>病歷號：</b>${item.record}<br>
            <b>注意事項：</b>${item.note}
            <div class="actions">
                <button onclick="editRecord('${item.id}','${item.name}','${item.record}','${item.note}')">編輯</button>
                <button class="delete" onclick="deleteRecord('${item.id}')">刪除</button>
            </div>
        </div>`;
    });
}

/* 編輯 */
function editRecord(id, name, record, note) {
    editingId = id;
    document.getElementById("name").value = name;
    document.getElementById("record").value = record;
    document.getElementById("note").value = note;
    document.getElementById("formTitle").innerText = "編輯資料";
    document.getElementById("saveBtn").innerText = "更新";
}

/* 刪除 */
function deleteRecord(id) {
    if (confirm("確定要刪除這筆資料？")) {
        fetch(api + "?action=delete&id=" + id)
            .then(r => r.text())
            .then(d => {
                alert(d);
                location.reload();
            });
    }
}
</script>

</body>
</html>
