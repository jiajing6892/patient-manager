<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<link rel="manifest" href="manifest.json">
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>

    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç—…äººè³‡æ–™ç®¡ç†</title>

<style>
    body {
        font-family: "Segoe UI", "Noto Sans TC", sans-serif;
        background: #f7f7fb;
        margin: 0; padding: 20px;
    }
    .container {
        max-width: 680px;
        background: white;
        margin: auto;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h2 {
        text-align: center;
        color: #4a4a4a;
        margin-bottom: 10px;
    }
    input, textarea {
        width: 100%;
        padding: 10px 12px;
        margin: 6px 0 12px;
        border-radius: 10px;
        border: 1px solid #d3d3e7;
        font-size: 16px;
    }
    button {
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 6px;
    }
    .btn-add { background:#8aa8ff; color:white; }
    .btn-edit { background:#4bd37b; color:white; }
    .btn-del { background:#ff7171; color:white; }
    .search-box {
        background:white;
        border:1px solid #d3d3e7;
        padding:10px;
        border-radius:10px;
        margin-top:10px;
    }
    table {
        width:100%; border-collapse: collapse; margin-top:20px;
    }
    table, th, td {
        border:1px solid #e1e1f0;
    }
    th, td {
        padding:8px;
        text-align:center;
        font-size:15px;
    }
    tr:hover { background:#f0f4ff; }
</style>
</head>

<body>

<div class="container">
    <h2>ğŸ“‹ ç—…äººè³‡æ–™ç®¡ç†ç³»çµ±</h2>

    <!-- è¡¨å–® -->
    <input type="text" id="name" placeholder="ç—…äººå§“å">
    <input type="text" id="mrn" placeholder="ç—…æ­·è™Ÿ">
    <textarea id="note" placeholder="æ³¨æ„äº‹é …"></textarea>
    <button class="btn-add" id="addBtn" onclick="addOrEdit()">æ–°å¢</button>

    <!-- æœå°‹ -->
    <div class="search-box">
        ğŸ” <input type="text" id="search" placeholder="æœå°‹å§“åæˆ–ç—…æ­·è™Ÿ" onkeyup="renderTable()">
    </div>

    <!-- è³‡æ–™è¡¨ -->
    <table id="patientTable">
        <thead>
            <tr>
                <th>å§“å</th>
                <th>ç—…æ­·è™Ÿ</th>
                <th>æ³¨æ„äº‹é …</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxa4GFiDtkde9gm-S1UddDhN6i8LoNP-EFpSPrkyFs5ikjVVKMDqWSkCkZHKVsqiawgZA/exec";
    let patients = [];
    let editRow = null; // è¨˜éŒ„æ­£åœ¨ç·¨è¼¯å“ªä¸€ç­†

    // ğŸš€ è®€å–é›²ç«¯è³‡æ–™
    async function loadData() {
        const res = await fetch(API + "?action=list");
        patients = await res.json();
        renderTable();
    }

    // ğŸ“ æ–°å¢ or æ›´æ–°
    async function addOrEdit() {
        let name = document.getElementById("name").value.trim();
        let mrn = document.getElementById("mrn").value.trim();
        let note = document.getElementById("note").value.trim();

        if (!name || !mrn) return alert("å§“åèˆ‡ç—…æ­·è™Ÿä¸å¯ç©ºç™½ï¼");

        // é˜²é‡è¤‡ï¼ˆæ–°å¢æ™‚ï¼‰
        if (!editRow) {
            let exist = patients.some(p => p.name === name && p.mrn === mrn);
            if (exist) return alert("âš  æ­¤ç—…äººè³‡æ–™å·²å­˜åœ¨ï¼");
        }

        let action = editRow ? "edit" : "add";
        let body = { action, name, mrn, note };
        if (editRow) body.row = editRow;

        await fetch(API, {
            method: "POST",
            body: JSON.stringify(body)
        });

        alert(editRow ? "å·²æ›´æ–°ï¼" : "å·²æ–°å¢ï¼");
        resetForm();
        loadData();
    }

    // âœ ç·¨è¼¯
    function editPatient(row) {
        let p = patients.find(x => x.row === row);
        document.getElementById("name").value = p.name;
        document.getElementById("mrn").value = p.mrn;
        document.getElementById("note").value = p.note;
        document.getElementById("addBtn").textContent = "æ›´æ–°";
        editRow = row;
    }

    // âŒ åˆªé™¤
    async function deletePatient(row) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
        await fetch(API, {
            method: "POST",
            body: JSON.stringify({ action: "delete", row })
        });
        loadData();
    }

    // ğŸ”„ é‡è¨­è¡¨å–®
    function resetForm() {
        document.getElementById("name").value = "";
        document.getElementById("mrn").value = "";
        document.getElementById("note").value = "";
        document.getElementById("addBtn").textContent = "æ–°å¢";
        editRow = null;
    }

    // ğŸ“Œ é¡¯ç¤ºè³‡æ–™ + æœå°‹
    function renderTable() {
        let keyword = document.getElementById("search").value.trim();
        let tbody = document.querySelector("#patientTable tbody");
        tbody.innerHTML = "";

        patients
            .filter(p => p.name.includes(keyword) || p.mrn.includes(keyword))
            .forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.mrn}</td>
                        <td>${p.note}</td>
                        <td>
                            <button class="btn-edit" onclick="editPatient(${p.row})">ç·¨è¼¯</button>
                            <button class="btn-del" onclick="deletePatient(${p.row})">åˆªé™¤</button>
                        </td>
                    </tr>`;
            });
    }

    loadData();
</script>

</body>
</html>
